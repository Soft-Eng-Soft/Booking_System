<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم والإدارة</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary-color: #1976D2; --danger-color: #d32f2f; --success-color: #2e7d32; --bg-color: #f4f6f8; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-color); color: #333; padding: 20px; }

        /* شاشة تسجيل الدخول */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; width: 300px;
        }
        .login-box input {
            width: 100%; padding: 10px; margin: 20px 0;
            border: 1px solid #ccc; border-radius: 5px; text-align: center;
        }

        /* المحتوى الرئيسي */
        .dashboard-container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: none; background: #eee; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .tab-btn.active { background: var(--primary-color); color: white; }

        /* الفلاتر */
        .filters { display: flex; flex-wrap: wrap; gap: 15px; background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; }
        .filter-group input, .filter-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* الجدول */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #ddd; }
        th { background: var(--primary-color); color: white; }
        tr:hover { background: #e3f2fd; }

        /* إعدادات النظام */
        .settings-panel { display: none; background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
        .settings-panel.active { display: block; }
        .setting-item { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .setting-item h3 { margin-bottom: 10px; color: var(--primary-color); }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary-color); }
        .btn-success { background: var(--success-color); }
        .btn-export { background: #217346; }

        @media print {
            .login-screen, .filters, .btn, .tabs, .header { display: none !important; }
            .dashboard-container { box-shadow: none; width: 100%; }
            table { border: 1px solid #000; }
            th, td { border: 1px solid #000; }
            body { background: white; padding: 0; }
        }
    </style>
</head>
<body>

    <!-- شاشة تسجيل الدخول -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> دخول المسؤول</h2>
            <input type="password" id="passwordInput" placeholder="أدخل كلمة المرور">
            <button class="btn btn-primary" style="width:100%" onclick="checkLogin()">دخول</button>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContent" style="display:none;">
        <div class="header">
            <h1>لوحة إدارة الحجوزات</h1>
            <a href="index.html" class="btn" style="background:#666;">العودة للحجز</a>
        </div>

        <!-- التبويبات -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('bookings')">عرض الحجوزات</button>
            <button class="tab-btn" onclick="showTab('settings')">إعدادات النظام</button>
        </div>

        <!-- محتوى الحجوزات -->
        <div id="bookingsTab">
            <div class="filters">
                <!-- فلتر المدة الزمنية -->
                <div class="filter-group">
                    <label>من تاريخ</label>
                    <input type="date" id="filterStartDate">
                </div>
                <div class="filter-group">
                    <label>إلى تاريخ</label>
                    <input type="date" id="filterEndDate">
                </div>

                <div class="filter-group"><label>الموقع</label>
                    <select id="filterSite">
                        <option value="">الكل</option>
                        <option value="سايلو الرمادي">سايلو الرمادي</option>
                        <option value="مجمع الرمادي الجديد">مجمع الرمادي الجديد</option>
                        <option value="مركز تسوق الخيرات">مركز تسوق الخيرات</option>
                        <option value="مركز تسويق عنه">مركز تسويق عنه</option>
                    </select>
                </div>
                <div class="filter-group"><label>اسم المسوق</label><input type="text" id="filterName" placeholder="بحث باسم المسوق..."></div>
                
                <div class="filter-group" style="display:flex; align-items:flex-end; gap:10px;">
                    <button class="btn btn-primary" onclick="fetchBookings()">بحث</button>
                    <button class="btn btn-export" onclick="exportToCSV()"><i class="fas fa-file-excel"></i> Excel</button>
                </div>
            </div>

            <table>
                <thead><tr><th>رقم الحجز</th><th>الموقع</th><th>التاريخ</th><th>المسوق</th><th>السيارة</th><th>السائق</th></tr></thead>
                <tbody id="bookingsBody">
                    <tr><td colspan="6" style="text-align:center; color:#888;">حدد التواريخ واضغط بحث</td></tr>
                </tbody>
            </table>
        </div>

        <!-- محتوى الإعدادات -->
        <div id="settingsTab" class="settings-panel">
            <h2>إعدادات النظام</h2>
            <p style="color:#666; margin-bottom:20px;">تغيير هذه الإعدادات سيتم تطبيقه فوراً على صفحة الحجز.</p>

            <div class="setting-item">
                <h3><i class="fas fa-cog"></i> الحد الأقصى للحجوزات (السعة)</h3>
                <p>العدد الحالي: <strong id="currentLimit">...</strong></p>
                <input type="number" id="newLimit" style="padding:8px; width:100px; margin-top:10px;" value="100">
                <button class="btn btn-success" onclick="updateLimit()">تحديث السعة</button>
            </div>

            <div class="setting-item">
                <h3><i class="fas fa-calendar-alt"></i> نطاق التواريخ</h3>
                <p>تعديل الفترة المسموح بالحجز فيها.</p>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="date" id="newStartDate" style="padding:8px;"> <label>من</label>
                    <input type="date" id="newEndDate" style="padding:8px;"> <label>إلى</label>
                </div>
                <button class="btn btn-primary" style="margin-top:15px;" onclick="updateDateRange()">تحديث التواريخ</button>
            </div>
        </div>
    </div>

    <script>
        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCRyuJulhSxZo9YAfa6jyDzomewt0W9nzM",
            authDomain: "bookingsys-377c4.firebaseapp.com",
            databaseURL: "https://bookingsys-377c4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bookingsys-377c4",
            storageBucket: "bookingsys-377c4.firebasestorage.app",
            messagingSenderId: "214843118228",
            appId: "1:214843118228:web:b342ac832c29d0612f1a81"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. تسجيل الدخول
        function checkLogin() {
            const pass = document.getElementById('passwordInput').value;
            if(pass === "123") {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                loadConfig();
            } else {
                alert("كلمة المرور خاطئة!");
            }
        }

        // 2. إدارة التبويبات
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.settings-panel, #bookingsTab').forEach(p => {
                if(p.id !== 'bookingsTab') p.style.display = 'none';
                else if(tabName === 'bookings') p.style.display = 'block';
            });
            
            if(tabName === 'settings') {
                document.querySelector('.settings-panel').style.display = 'block';
                document.getElementById('bookingsTab').style.display = 'none';
            }
            event.target.classList.add('active');
        }

        // 3. جلب البيانات (محدث لدعم الفترات الزمنية)
        async function fetchBookings() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const siteFilter = document.getElementById('filterSite').value;
            const nameFilter = document.getElementById('filterName').value.toLowerCase();
            const tbody = document.getElementById('bookingsBody');

            if (!startDate) {
                alert("يرجى اختيار 'من تاريخ' على الأقل");
                return;
            }

            tbody.innerHTML = '<tr><td colspan="6">جاري التحميل...</td></tr>';
            let allBookings = [];

            try {
                let ref = db.ref('bookings');

                // تحديد نوع الاستعلام: يوم واحد أم فترة
                if (startDate && endDate) {
                    // بحث في فترة زمنية
                    ref = ref.orderByKey().startAt(startDate).endAt(endDate);
                    const snapshot = await ref.once('value');

                    if (snapshot.exists()) {
                        snapshot.forEach(dateSnapshot => {
                            const dateKey = dateSnapshot.key; // التاريخ
                            dateSnapshot.forEach(bookingSnapshot => {
                                let data = bookingSnapshot.val();
                                data.date = dateKey; // تعيين التاريخ لكل حجز
                                allBookings.push(data);
                            });
                        });
                    }
                } else {
                    // بحث في يوم واحد
                    const snapshot = await ref.child(startDate).once('value');
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            let data = childSnapshot.val();
                            data.date = startDate;
                            allBookings.push(data);
                        });
                    }
                }

                // تفريغ الجدول
                tbody.innerHTML = '';

                if (allBookings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">لا توجد حجوزات في الفترة المحددة</td></tr>';
                    return;
                }

                // الترتيب: حسب التاريخ أولاً، ثم حسب رقم الحجز
                allBookings.sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.bookingId - b.bookingId;
                });

                // تطبيق الفلاتر وعرض البيانات
                let hasData = false;
                allBookings.forEach(booking => {
                    // فلترة الموقع
                    if (siteFilter && booking.site !== siteFilter) return;
                    // فلترة الاسم
                    if (nameFilter && (!booking.marketer || !booking.marketer.toLowerCase().includes(nameFilter))) return;

                    hasData = true;
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td><strong>${booking.bookingId}</strong></td>
                        <td>${booking.site}</td>
                        <td>${booking.date}</td>
                        <td>${booking.marketer || '-'}</td>
                        <td>${booking.carNum}</td>
                        <td>${booking.driver}</td>
                    `;
                    tbody.appendChild(row);
                });

                if (!hasData) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">لا توجد نتائج تطابق الفلاتر</td></tr>';
                }

            } catch (error) {
                console.error("Error:", error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">حدث خطأ في الاتصال</td></tr>';
            }
        }

        // 4. تصدير CSV
        function exportToCSV() {
            let csv = [];
            let rows = document.querySelectorAll("table tr");
            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length; j++) 
                    row.push('"' + cols[j].innerText + '"');
                csv.push(row.join(","));
            }
            downloadCSV(csv.join("\n"), "حجوزات.csv");
        }

        function downloadCSV(csv, filename) {
            let csvFile = new Blob(["\ufeff"+csv], {type: "text/csv;charset=utf-8;"});
            let downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        // 5. تحميل وتحديث الإعدادات
        async function loadConfig() {
            const limitSnap = await db.ref('config/maxBookings').once('value');
            const limit = limitSnap.val() || 100;
            document.getElementById('currentLimit').innerText = limit;
            document.getElementById('newLimit').value = limit;

            const startSnap = await db.ref('config/startDate').once('value');
            const endSnap = await db.ref('config/endDate').once('value');
            if(startSnap.exists()) document.getElementById('newStartDate').value = startSnap.val();
            if(endSnap.exists()) document.getElementById('newEndDate').value = endSnap.val();
        }

        async function updateLimit() {
            const val = document.getElementById('newLimit').value;
            await db.ref('config/maxBookings').set(Number(val));
            alert('تم تحديث السعة بنجاح');
            loadConfig();
        }

        async function updateDateRange() {
            const start = document.getElementById('newStartDate').value;
            const end = document.getElementById('newEndDate').value;
            if(!start || !end) { alert('يرجى تحديد التواريخ'); return; }
            await db.ref('config/startDate').set(start);
            await db.ref('config/endDate').set(end);
            alert('تم تحديث التواريخ بنجاح.');
        }
    </script>
</body>
</html>
