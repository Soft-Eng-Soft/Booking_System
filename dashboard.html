<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - إدارة المواقع المتقدمة</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary-color: #1976D2; --danger-color: #d32f2f; --success-color: #2e7d32; --bg-color: #f4f6f8; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); padding: 20px; }

        /* تنسيق اللوحة */
        .dashboard-container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 25px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 6px; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: var(--primary-color); color: white; }

        /* النماذج والجداول */
        .card { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; text-align: right; border: 1px solid #dee2e6; }
        th { background: #444; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; }
        
        /* إعدادات الطباعة الخاصة بالـ PDF */
        #pdfContent { padding: 20px; background: white; }
        .pdf-header { text-align: center; margin-bottom: 20px; display: none; } /* تظهر فقط في PDF */

        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container" id="mainContent">
        <div class="header no-print">
            <h1><i class="fas fa-tasks"></i> إدارة منظومة الحجز 2026</h1>
            <a href="index.html" class="btn" style="background:#666;">العودة لصفحة الحجز</a>
        </div>

        <div class="tabs no-print">
            <button class="tab-btn active" onclick="showTab('bookings')">سجل الحجوزات</button>
            <button class="tab-btn" onclick="showTab('settings')">إعدادات المواقع</button>
        </div>

        <div id="bookingsTab">
            <div class="card no-print">
                <div class="grid-3">
                    <div class="form-group"><label>من تاريخ</label><input type="date" id="filterStart"></div>
                    <div class="form-group"><label>إلى تاريخ</label><input type="date" id="filterEnd"></div>
                    <div class="form-group">
                        <label>الموقع</label>
                        <select id="filterSite">
                            <option value="">كل المواقع</option>
                            <option value="سايلو الرمادي">سايلو الرمادي</option>
                            <option value="مجمع الرمادي الجديد">مجمع الرمادي الجديد</option>
                            <option value="مركز تسوق الخيرات">مركز تسوق الخيرات</option>
                            <option value="مركز تسويق عنه">مركز تسويق عنه</option>
                        </select>
                    </div>
                </div>
                <button class="btn" style="background:var(--primary-color);" onclick="fetchBookings()"><i class="fas fa-search"></i> بحث وتحديث</button>
            </div>

            <div class="no-print" style="margin-bottom: 10px; text-align: left;">
                <button class="btn" style="background:var(--danger-color);" onclick="exportDetailedPDF()"><i class="fas fa-file-pdf"></i> تحميل التقرير التفصيلي PDF</button>
            </div>

            <div id="printableArea">
                <div class="pdf-header" id="pdfHeader">
                    <h2>تقرير حجوزات التسويق لعام 2026</h2>
                    <p id="pdfDateRange"></p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>رقم الحجز</th>
                            <th>الموقع</th>
                            <th>التاريخ</th>
                            <th>المسوق</th>
                            <th>رقم الكتاب</th>
                            <th>السيارة</th>
                            <th>السائق</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsBody">
                        <tr><td colspan="7" style="text-align:center;">يرجى اختيار التاريخ والضغط على بحث</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="settingsTab" style="display:none;">
            <div class="card">
                <h3><i class="fas fa-cogs"></i> تخصيص إعدادات الموقع</h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">يمكنك تحديد سعة مختلفة ونطاق تاريخ لكل موقع بشكل مستقل.</p>
                
                <div class="form-group" style="max-width: 300px;">
                    <label>اختر الموقع المُراد تعديله:</label>
                    <select id="settingSiteSelector" onchange="loadSiteConfig(this.value)">
                        <option value="">-- اختر موقعاً --</option>
                        <option value="سايلو الرمادي">سايلو الرمادي</option>
                        <option value="مجمع الرمادي الجديد">مجمع الرمادي الجديد</option>
                        <option value="مركز تسوق الخيرات">مركز تسوق الخيرات</option>
                        <option value="مركز تسويق عنه">مركز تسويق عنه</option>
                    </select>
                </div>

                <div id="configForm" style="display:none; border-top: 1px solid #ddd; padding-top: 20px;">
                    <div class="grid-3">
                        <div class="form-group"><label>الحد الأقصى اليومي (السعة)</label><input type="number" id="mLimit"></div>
                        <div class="form-group"><label>تاريخ البدء</label><input type="date" id="mStart"></div>
                        <div class="form-group"><label>تاريخ الانتهاء</label><input type="date" id="mEnd"></div>
                    </div>
                    <button class="btn" style="background:var(--success-color);" onclick="saveConfig()"><i class="fas fa-check"></i> حفظ الإعدادات للموقع</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تكوين Firebase الخاص بك
        const firebaseConfig = {
            apiKey: "AIzaSyCRyuJulhSxZo9YAfa6jyDzomewt0W9nzM",
            authDomain: "bookingsys-377c4.firebaseapp.com",
            databaseURL: "https://bookingsys-377c4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bookingsys-377c4",
            storageBucket: "bookingsys-377c4.firebasestorage.app",
            messagingSenderId: "214843118228",
            appId: "1:214843118228:web:b342ac832c29d0612f1a81"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function showTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('bookingsTab').style.display = (t === 'bookings') ? 'block' : 'none';
            document.getElementById('settingsTab').style.display = (t === 'settings') ? 'block' : 'none';
        }

        // جلب إعدادات موقع معين
        async function loadSiteConfig(site) {
            if(!site) { document.getElementById('configForm').style.display='none'; return; }
            const snap = await db.ref('site_configs/' + site).once('value');
            const conf = snap.val() || { maxBookings: 100, startDate: '', endDate: '' };
            document.getElementById('mLimit').value = conf.maxBookings;
            document.getElementById('mStart').value = conf.startDate;
            document.getElementById('mEnd').value = conf.endDate;
            document.getElementById('configForm').style.display = 'block';
        }

        // حفظ إعدادات الموقع
        async function saveConfig() {
            const site = document.getElementById('settingSiteSelector').value;
            const data = {
                maxBookings: parseInt(document.getElementById('mLimit').value),
                startDate: document.getElementById('mStart').value,
                endDate: document.getElementById('mEnd').value
            };
            await db.ref('site_configs/' + site).set(data);
            alert("تم تحديث إعدادات " + site + " بنجاح.");
        }

        // جلب الحجوزات
        async function fetchBookings() {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            const site = document.getElementById('filterSite').value;
            const tbody = document.getElementById('bookingsBody');

            if(!start) { alert("حدد تاريخ البدء"); return; }
            tbody.innerHTML = '<tr><td colspan="7">جاري البحث...</td></tr>';

            const snap = await db.ref('bookings').orderByKey().startAt(start).endAt(end || start).once('value');
            tbody.innerHTML = '';
            
            let hasData = false;
            snap.forEach(dateSnap => {
                dateSnap.forEach(bookingSnap => {
                    const b = bookingSnap.val();
                    if(site && b.site !== site) return;
                    hasData = true;
                    tbody.innerHTML += `<tr>
                        <td><b>${b.bookingId}</b></td>
                        <td>${b.site} [cite: 5]</td>
                        <td>${dateSnap.key} [cite: 6]</td>
                        <td>${b.marketer} </td>
                        <td>${b.agBook || '-'}</td>
                        <td>${b.carNum || '-'}</td>
                        <td>${b.driver || '-'}</td>
                    </tr>`;
                });
            });
            if(!hasData) tbody.innerHTML = '<tr><td colspan="7">لا توجد حجوزات تطابق البحث</td></tr>';
        }

        // وظيفة PDF المتقدمة
        function exportDetailedPDF() {
            const element = document.getElementById('printableArea');
            const header = document.getElementById('pdfHeader');
            header.style.display = 'block'; // إظهار هيدر التقرير في الـ PDF

            const opt = {
                margin: 0.3,
                filename: 'تقرير_الحجوزات_2026.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                header.style.display = 'none'; // إخفاؤه مرة أخرى من الشاشة
            });
        }
    </script>
</body>
</html>
