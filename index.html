<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منظومة حجز التسويق 2026</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary-color: #1976D2; --bg-color: #f8f9fa; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: var(--bg-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        
        .booking-card { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-top: 8px solid var(--primary-color); }
        h2 { text-align: center; color: #333; margin-bottom: 25px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        .btn-submit { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

        .info-box { background: #e3f2fd; padding: 10px; border-radius: 8px; font-size: 0.9em; color: #0d47a1; margin-bottom: 15px; display: none; }

        /* تنسيق وصل الحجز للـ PDF */
        #ticket { display: none; direction: rtl; padding: 30px; border: 2px solid #333; background: #fff; }
        .ticket-header { text-align: center; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px; margin-bottom: 20px; }
        .ticket-id-box { text-align: center; margin-bottom: 25px; }
        .ticket-id { font-size: 45px; color: #d32f2f; font-weight: bold; border: 3px solid #d32f2f; display: inline-block; padding: 10px 40px; border-radius: 12px; }
        .ticket-row { border-bottom: 1px solid #eee; padding: 12px 5px; display: flex; justify-content: space-between; font-size: 17px; }
    </style>
</head>
<body>

    <div class="booking-card" id="mainCard">
        <div id="formSection">
            <h2><i class="fas fa-calendar-check"></i> حجز موعد تسويق 2026</h2>
            
            <div id="capacityInfo" class="info-box"></div>

            <form id="bookingForm">
                <div class="form-group">
                    <label>اختر الموقع</label>
                    <select id="site" required onchange="handleSiteChange()">
                        <option value="">-- اختر الموقع --</option>
                        <option value="سايلو الرمادي">سايلو الرمادي</option>
                        <option value="مجمع الرمادي الجديد">مجمع الرمادي الجديد</option>
                        <option value="مركز تسوق الخيرات">مركز تسوق الخيرات</option>
                        <option value="مركز تسويق عنه">مركز تسويق عنه</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>تاريخ الحجز</label>
                    <input type="date" id="bookingDate" required disabled onchange="checkCapacity()">
                </div>

                <div class="form-group">
                    <label>اسم المسوق</label>
                    <input type="text" id="marketer" placeholder="الاسم الرباعي" required>
                </div>

                <div class="form-group">
                    <label>رقم كتاب التجهيز</label>
                    <input type="text" id="agBook" required>
                </div>

                <div class="form-group">
                    <label>رقم السيارة</label>
                    <input type="text" id="carNum" placeholder="مثال: 12345 أ" required>
                </div>

                <div class="form-group">
                    <label>اسم السائق</label>
                    <input type="text" id="driver" required>
                </div>

                <button type="submit" id="submitBtn" class="btn-submit">تأكيد الحجز وحفظ الوصل</button>
            </form>
        </div>

        <div id="ticket">
            <div class="ticket-header">
                <h2 style="color: #1976D2;">تأكيد الحجز المسبق</h2>
                <p>يرجى إبراز هذا الوصل (رقمياً أو ورقياً) عند مدخل الموقع</p>
            </div>
            
            <div class="ticket-id-box">
                <span style="display:block; margin-bottom:5px; font-weight:bold;">رقم الحجز الخاص بك:</span>
                <div id="t-id" class="ticket-id"></div>
            </div>

            <div class="ticket-row"><strong>الموقع المستهدف:</strong> <span id="t-site"></span></div>
            <div class="ticket-row"><strong>تاريخ الحجز:</strong> <span id="t-date"></span></div>
            <div class="ticket-row"><strong>اسم المسوق:</strong> <span id="t-marketer"></span></div>
            <div class="ticket-row"><strong>رقم السيارة:</strong> <span id="t-car"></span></div>
            <div class="ticket-row"><strong>اسم السائق:</strong> <span id="t-driver"></span></div>
            
            <div style="margin-top: 30px; text-align: center; font-size: 13px; color: #777; border-top: 1px solid #ddd; padding-top: 10px;">
                صدر هذا الوصل بتاريخ: <span id="t-now"></span>
            </div>
        </div>
    </div>

    <script>
        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCRyuJulhSxZo9YAfa6jyDzomewt0W9nzM",
            authDomain: "bookingsys-377c4.firebaseapp.com",
            databaseURL: "https://bookingsys-377c4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bookingsys-377c4",
            storageBucket: "bookingsys-377c4.firebasestorage.app",
            messagingSenderId: "214843118228",
            appId: "1:214843118228:web:b342ac832c29d0612f1a81"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentSiteConfig = null;

        // عند تغيير الموقع
        async function handleSiteChange() {
            const site = document.getElementById('site').value;
            const dateInput = document.getElementById('bookingDate');
            const infoBox = document.getElementById('capacityInfo');

            if (!site) { dateInput.disabled = true; infoBox.style.display = 'none'; return; }

            const snapshot = await db.ref('site_configs/' + site).once('value');
            currentSiteConfig = snapshot.val();

            if (currentSiteConfig) {
                dateInput.disabled = false;
                dateInput.min = currentSiteConfig.startDate;
                dateInput.max = currentSiteConfig.endDate;
                dateInput.value = ""; 
                infoBox.innerHTML = `<i class="fas fa-info"></i> الحجز متاح في ${site} لغاية ${currentSiteConfig.endDate}`;
                infoBox.style.display = 'block';
                infoBox.style.color = "#0d47a1";
            } else {
                alert("لم يتم ضبط إعدادات هذا الموقع بعد.");
                dateInput.disabled = true;
            }
        }

        // التحقق من السعة
        async function checkCapacity() {
            const site = document.getElementById('site').value;
            const date = document.getElementById('bookingDate').value;
            const submitBtn = document.getElementById('submitBtn');
            const infoBox = document.getElementById('capacityInfo');

            const bookingsSnap = await db.ref('bookings/' + date).once('value');
            let count = 0;
            bookingsSnap.forEach(snap => { if(snap.val().site === site) count++; });

            const max = currentSiteConfig ? currentSiteConfig.maxBookings : 100;

            if (count >= max) {
                infoBox.innerHTML = `<i class="fas fa-times-circle"></i> عذراً، هذا التاريخ مكتمل لهذا الموقع (${count}/${max})`;
                infoBox.style.color = "red";
                submitBtn.disabled = true;
            } else {
                infoBox.innerHTML = `<i class="fas fa-check-circle"></i> الموعد متاح (تم حجز ${count} من أصل ${max})`;
                infoBox.style.color = "green";
                submitBtn.disabled = false;
            }
        }

        // معالجة الحجز
        document.getElementById('bookingForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "جاري الحجز وتوليد الوصل...";

            const formData = {
                site: document.getElementById('site').value,
                date: document.getElementById('bookingDate').value,
                marketer: document.getElementById('marketer').value,
                agBook: document.getElementById('agBook').value,
                carNum: document.getElementById('carNum').value,
                driver: document.getElementById('driver').value,
                timestamp: Date.now()
            };

            const dayRef = db.ref('bookings/' + formData.date);
            const snap = await dayRef.once('value');
            formData.bookingId = (snap.numChildren() || 0) + 1;

            await dayRef.push(formData);

            // ملء بيانات الوصل
            document.getElementById('t-id').innerText = formData.bookingId;
            document.getElementById('t-site').innerText = formData.site;
            document.getElementById('t-date').innerText = formData.date;
            document.getElementById('t-marketer').innerText = formData.marketer;
            document.getElementById('t-car').innerText = formData.carNum;
            document.getElementById('t-driver').innerText = formData.driver;
            document.getElementById('t-now').innerText = new Date().toLocaleString('ar-EG');

            // التحويل لـ PDF
            document.getElementById('formSection').style.display = 'none';
            const ticket = document.getElementById('ticket');
            ticket.style.display = 'block';

            const opt = {
                margin: 0.5,
                filename: `وصل_حجز_${formData.bookingId}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(ticket).save().then(() => {
                alert("تم إتمام الحجز وحفظ الوصل بنجاح!");
                window.location.reload();
            });
        };
    </script>
</body>
</html>
