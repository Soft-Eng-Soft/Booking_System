<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الحجز المسبق ومواعيد التسويق لعام 2026</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { 
            --primary-color: #2e7d32; 
            --text-color: #333; 
            --error-color: #d32f2f; 
            --shadow: 0 4px 6px rgba(0,0,0,0.1); 
            --radius: 8px; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { 
            background-color: #e8f5e9; 
            color: var(--text-color); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px; 
        }

        .container { 
            background: white; 
            width: 100%; 
            max-width: 600px; 
            padding: 30px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            border-top: 5px solid var(--primary-color); 
        }

        header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--primary-color); margin-bottom: 10px; font-size: 22px; }
        p { color: #666; font-size: 14px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: var(--radius); 
            font-size: 15px; 
            background: #fafafa;
        }

        .btn-submit { 
            width: 100%; 
            padding: 14px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: var(--radius); 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.3s;
        }

        .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Modal Style */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.7); 
            display: none; justify-content: center; align-items: center; 
            z-index: 1000; overflow-y: auto;
        }

        .modal-content { 
            background: white; padding: 30px; border-radius: var(--radius); 
            width: 90%; max-width: 450px; text-align: center; 
        }

        .ref-number { 
            font-size: 40px; font-weight: 900; color: var(--error-color); 
            margin: 15px 0; display: block; border: 2px dashed #ddd; padding: 10px;
        }

        .booking-details { text-align: right; margin-top: 15px; font-size: 16px; }
        .booking-details p { margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .booking-details strong { color: var(--primary-color); }

        .modal-actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn-modal { padding: 12px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-save-image { background: var(--primary-color); color: white; }
        .btn-save-pdf { background: #333; color: white; }
        .btn-close { background: #eee; }

        .spinner { 
            display: inline-block; width: 20px; height: 20px; 
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; border-top-color: #fff; 
            animation: spin 1s ease-in-out infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>الشركة العامة لتجارة الحبوب/ فرع الأنبار</h1>
            <h1>نظام الحجز المسبق ومواعيد التسويق 2026</h1>
            <p>يرجى إدخال البيانات المطلوبة بدقة لضمان الحجز</p>
        </header>

        <form id="bookingForm">
            <div class="form-group">
                <label>موقع التسويق *</label>
                <select id="marketingSite" required>
                    <option value="" disabled selected>اختر الموقع...</option>
                    <option value="سايلو الرمادي">سايلو الرمادي</option>
                    <option value="مجمع الرمادي الجديد">مجمع الرمادي الجديد</option>
                    <option value="مركز تسوق الخيرات">مركز تسوق الخيرات</option>
                    <option value="مركز تسويق عنه">مركز تسويق عنه</option>
                </select>
            </div>

            <div class="form-group">
                <label>اسم المسوق رباعي *</label>
                <input type="text" id="marketerName" placeholder="أدخل الاسم الكامل" required>
            </div>

            <div class="form-group">
                <label>رقم كتاب الزراعة *</label>
                <input type="text" id="agricultureBook" required>
            </div>

            <div class="form-group">
                <label>تاريخ كتاب الزراعة *</label>
                <input type="date" id="bookDate" required>
            </div>

            <div class="form-group">
                <label>رقم السيارة *</label>
                <input type="text" id="carNumber" placeholder="رقم السيارة والمحافظة" required>
            </div>

            <div class="form-group">
                <label>اسم السائق *</label>
                <input type="text" id="driverName" required>
            </div>

            <div class="form-group">
                <label>تاريخ الحجز المطلوب *</label>
                <select id="bookingDate" required>
                    <option value="" disabled selected>اختر التاريخ أولاً...</option>
                </select>
                <div id="capacityStatus" style="display:none; font-size: 12px; margin-top:5px; color: var(--primary-color);">
                    المقاعد المتاحة: <span id="countDisplay">0/0</span>
                </div>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn">
                <span id="btnText">تأكيد الحجز الآن</span>
            </button>
        </form>
    </div>

    <div class="modal-overlay" id="successModal">
        <div class="modal-content" id="ticket">
            <h2 style="color: var(--primary-color);">تأكيد الحجز المسبق</h2>
            <p>احتفظ بنسخة من هذا الرقم لإبرازه عند الدخول</p>
            
            <span id="refNumberDisplay" class="ref-number">---</span>

            <div class="booking-details" id="bookingDetailsContent">
                </div>

            <div class="modal-actions" id="downloadActions">
                <button class="btn-modal btn-save-image" onclick="saveAsImage()">حفظ كصورة (المعرض)</button>
                <button class="btn-modal btn-save-pdf" onclick="saveAsPDF()">تحميل PDF</button>
                <button class="btn-modal btn-close" onclick="closeModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCRyuJulhSxZo9YAfa6jyDzomewt0W9nzM",
            authDomain: "bookingsys-377c4.firebaseapp.com",
            databaseURL: "https://bookingsys-377c4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bookingsys-377c4",
            storageBucket: "bookingsys-377c4.firebasestorage.app",
            messagingSenderId: "214843118228",
            appId: "1:214843118228:web:b342ac832c29d0612f1a81"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.database();

        let MAX_BOOKINGS = 100;
        const bookingDateSelect = document.getElementById('bookingDate');

        // --- Initialize App ---
        document.addEventListener('DOMContentLoaded', () => {
            generateDates();
            loadSettings();
        });

        async function loadSettings() {
            const snap = await db.ref('config/maxBookings').once('value');
            if(snap.exists()) MAX_BOOKINGS = snap.val();
        }

        function generateDates() {
            const today = new Date();
            for (let i = 1; i <= 30; i++) {
                let d = new Date();
                d.setDate(today.getDate() + i);
                let dateStr = d.toISOString().split('T')[0];
                let option = new Option(dateStr, dateStr);
                bookingDateSelect.add(option);
            }
        }

        // --- Logic ---
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> جاري المعالجة...';

            const data = {
                site: document.getElementById('marketingSite').value,
                marketer: document.getElementById('marketerName').value,
                agBook: document.getElementById('agricultureBook').value,
                bookDate: document.getElementById('bookDate').value,
                carNum: document.getElementById('carNumber').value,
                driver: document.getElementById('driverName').value,
                date: document.getElementById('bookingDate').value,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                // 1. التحقق من التكرار في نفس اليوم
                const dayRef = db.ref('bookings').child(data.date);
                const daySnap = await dayRef.once('value');
                let isDuplicate = false;

                daySnap.forEach(child => {
                    const b = child.val();
                    if (b.carNum === data.carNum || b.agBook === data.agBook) {
                        isDuplicate = true;
                    }
                });

                if (isDuplicate) {
                    alert("خطأ: السيارة أو رقم الكتاب مسجل بالفعل لهذا اليوم!");
                    throw "Duplicate entry";
                }

                // 2. الحجز باستخدام Transaction لضمان العدد
                const counterRef = db.ref(`counters/${data.site}/${data.date}`);
                const transactionResult = await counterRef.transaction(currentCount => {
                    if (currentCount >= MAX_BOOKINGS) return; // Full
                    return (currentCount || 0) + 1;
                });

                if (!transactionResult.committed) {
                    alert("عذراً، هذا الموقع ممتلئ في التاريخ المحدد.");
                } else {
                    const bookingId = transactionResult.snapshot.val();
                    await dayRef.push({ ...data, ticketId: bookingId });
                    showSuccess(data, bookingId);
                    document.getElementById('bookingForm').reset();
                }

            } catch (err) {
                console.error(err);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = "تأكيد الحجز الآن";
            }
        });

        function showSuccess(data, id) {
            document.getElementById('refNumberDisplay').innerText = id;
            document.getElementById('bookingDetailsContent').innerHTML = `
                <p><strong>الموقع:</strong> ${data.site}</p>
                <p><strong>تاريخ الحجز:</strong> ${data.date}</p>
                <p><strong>المسوق:</strong> ${data.marketer}</p>
                <p><strong>رقم السيارة:</strong> ${data.carNum}</p>
                <p><strong>رقم الكتاب:</strong> ${data.agBook}</p>
            `;
            document.getElementById('successModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('successModal').style.display = 'none'; }

        // --- Export Functions ---
        function saveAsImage() {
            const actions = document.getElementById('downloadActions');
            actions.style.visibility = 'hidden';
            
            html2canvas(document.getElementById('ticket'), { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'ticket-2026.png';
                link.href = canvas.toDataURL();
                link.click();
                actions.style.visibility = 'visible';
            });
        }

        function saveAsPDF() {
            const element = document.getElementById('ticket');
            const actions = document.getElementById('downloadActions');
            actions.style.visibility = 'hidden';

            const opt = {
                margin: 10,
                filename: 'حجز_التسويق_2026.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                actions.style.visibility = 'visible';
            });
        }
    </script>
</body>
</html>
